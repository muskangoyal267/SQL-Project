DECLARE DATE_LAG int64;
DECLARE LOAD_DATE DATE;
SET DATE_LAG = 0;
SET LOAD_DATE='2021-07-05';

WITH DATES AS
  (
  SELECT DISTINCT DATE_TRUNC(day, MONTH) day
   FROM UNNEST( GENERATE_DATE_ARRAY('2019-08-01', CURRENT_DATE())) AS day
  ),
  
 
BG1 AS (SELECT HOUSE_ID, ACCOMMODATION_CODE, CONTRACT_TYPE FROM(
  SELECT HOUSE_ID, ACCOMMODATION_CODE, CONTRACT_TYPE, STATUS_CODE, 
ROW_NUMBER() OVER (PARTITION BY HOUSE_ID, ACCOMMODATION_CODE, CONTRACT_TYPE, STATUS_CODE ORDER BY ACCOMMODATION_CODE ASC, CONTRACT_TYPE ASC, CURR_CONTRACT_DATE DESC) AS RANKS FROM  `leisure-bi.0_SUPPLY_DM.BV_CURRENT_HOUSE_CONTRACT_TYPE`)
  WHERE RANKS=1
  and CONTRACT_TYPE <> 'Unknown' 

  
  
  union all
  select distinct HOUSE_ID ,I.ACCOMMODATION_ID ,I.PROPERTY_CONTRACT_TYPE_OLD 
  FROM `leisure-bi.DM.VRMC_INVENTORY_FLOW` I
  where I.COMPANY ='DANCENTER'
  ),

BG2 AS (#SELECT HOUSE_ID, ACCOMMODATION_CODE, CONTRACT_TYPE FROM(
  #SELECT HOUSE_ID, ACCOMMODATION_CODE, CONTRACT_TYPE, STATUS_CODE, 
#ROW_NUMBER() OVER (PARTITION BY HOUSE_ID, ACCOMMODATION_CODE, CONTRACT_TYPE, STATUS_CODE ORDER BY ACCOMMODATION_CODE ASC, CONTRACT_TYPE ASC, CURR_CONTRACT_DATE DESC) AS RANKS FROM  `leisure-bi.0_SUPPLY_DM.BV_CURRENT_HOUSE_CONTRACT_TYPE`)
  #WHERE RANKS=1
  
  
  #union all
  select distinct HOUSE_ID ,I.ACCOMMODATION_ID as ACCOMMODATION_CODE ,I.PROPERTY_CONTRACT_TYPE_OLD as CONTRACT_TYPE
  FROM `leisure-bi.DM.VRMC_INVENTORY_FLOW` I
  WHERE SNAP = LOAD_DATE 

  #where I.COMPANY ='DANCENTER'
  ),

AGENT AS (SELECT HOUSE_ID, ACCOMMODATION_CODE, CONTRACT_TYPE, SALES_AGENT FROM(
  SELECT HOUSE_ID, ACCOMMODATION_CODE, CONTRACT_TYPE, STATUS_CODE, SALES_AGENT, ROW_NUMBER() OVER (PARTITION BY HOUSE_ID, ACCOMMODATION_CODE, CONTRACT_TYPE, STATUS_CODE ORDER BY ACCOMMODATION_CODE ASC, CONTRACT_TYPE ASC, CURR_CONTRACT_DATE DESC) AS RANKS FROM `leisure-bi.0_YIELD_DM.BV_REVENUE_BODYGUARD_CONTRACT_CHECK`)
  WHERE RANKS=1
  #AND STATUS_CODE = "D"
  ),

HOMES AS
  (
  SELECT DISTINCT HOUSE_ID, ACCOMMODATION_ID AS ACCOMMODATION_CODE , COMPANY, COUNTRY_NAME AS COUNTRY,
    FROM `leisure-bi.DM.VRMC_INVENTORY_FLOW` 
    WHERE SELLABLE = 1
    AND snap =LOAD_DATE
  ),
NEW_HOMES AS 
  (
  SELECT DISTINCT HOUSE_ID, I.ACCOMMODATION_ID, extract(year from  DATE_SUB(snap, INTERVAL 1 DAY))*100+extract(month from DATE_SUB(snap, INTERVAL 1 DAY)) as YEARMON,
  FLOW_L1, FLOW_L2, FLOW_L3
    FROM `leisure-bi.DM.VRMC_INVENTORY_FLOW` I
    where  (snap in (select max(snap) from `leisure-bi.DM.VRMC_INVENTORY_FLOW`) or snap in (select day from (
  SELECT DISTINCT DATE_TRUNC(day, MONTH) day
   FROM UNNEST( GENERATE_DATE_ARRAY('2019-08-01', CURRENT_DATE())) AS day
  ))) 
    and ((FLOW_L1 = 'Add' and FLOW_L2 = 'New' and FLOW_L3 = 'Organic') or
          (FLOW_L1 = 'Add' and FLOW_L2 = 'Existing' and FLOW_L3 = 'Win-back') or
          (FLOW_L1 = 'Add' and FLOW_L2 = 'New' and FLOW_L3 = 'Acquistion')
        )
    and CADENCE = 'MONTHLY' 
    #and PROPERTY_CONTRACT_TYPE in ("FME", "FME2.0")
    and SELLABLE = 1
    and I.HOUSE_ID not like '%US%'
    AND I.ACCOMMODATION_ID IS NOT NULL
  ),
DDATE AS 
(SELECT PropertyCode, Status, ContractType, DDate FROM `leisure-bi.LANDING.DC_ACCOMMODATION_BASIC_*` DC
WHERE DC._TABLE_SUFFIX = FORMAT_DATE('%Y%m%d', DATE_ADD(LOAD_DATE, INTERVAL DATE_LAG DAY))
UNION ALL
SELECT PropertyCode, Status, ContractType, DDate FROM `leisure-bi.LANDING.ACCOMMODATION_BASIC_*`B
WHERE B._TABLE_SUFFIX = FORMAT_DATE('%Y%m%d', DATE_ADD(LOAD_DATE, INTERVAL DATE_LAG DAY))),

BV_ACCO AS (SELECT * FROM `rev-man-leisure.DM.BV_ACCO`),

DCR AS (SELECT house_id, region_1, region_2, region_3, region_4 
FROM `ovh-dynamic-pricing.PUBLIC.DC_REGION`
order by house_id),

ACCO AS (
    SELECT distinct HOUSE_ID, ACCOMMODATION_ID AS ACCOMMODATION_CODE FROM `leisure-bi.1_PROPERTY_DATA.HOUSE_ID_*`A 
    WHERE A._TABLE_SUFFIX = FORMAT_DATE('%Y%m%d', DATE_ADD(LOAD_DATE, INTERVAL DATE_LAG DAY))
    AND IS_ACTIVE = 1
),

HOMESL AS (SELECT *, IF(YEARMON = 201901, "STOCK", IF(YEARMON <= 202006, "L1", IF(YEARMON <=202012, "L2", "L3"))) AS ADDS FROM (  
SELECT distinct H.HOUSE_ID, H.ACCOMMODATION_CODE, H.COMPANY, IF(N.YEARMON IS NULL, 201901, N.YEARMON) AS YEARMON, H.COUNTRY,
  IF(N.HOUSE_ID IS NULL,'Stock Homes','New Homes') STOCK, DDATE.Status,
  IF(H.COMPANY = "BELVILLA", BV_ACCO.REGION, DCR.region_2) AS REGION,
  IF(H.COMPANY = "BELVILLA", IF(BV_ACCO.ACCO_DESCRIPTION = "Apartment", "Apartment", "Non-Apartment"), "DC Homes") AS HOME_TYPE,
  ifnull(BG1.CONTRACT_TYPE, BG2.CONTRACT_TYPE) AS CONTRACT_TYPE,
  IF(H.COMPANY = "BELVILLA", AGENT.SALES_AGENT,"-") AS BDM,
  ROW_NUMBER() OVER (PARTITION BY H.HOUSE_ID, H.ACCOMMODATION_CODE ORDER BY H.HOUSE_ID ASC, H.ACCOMMODATION_CODE ASC, YEARMON DESC) AS RANKING,
  N.FLOW_L1, N.FLOW_L2, N.FLOW_L3
    FROM HOMES H
    LEFT JOIN NEW_HOMES N
    ON N.HOUSE_ID = H.HOUSE_ID
    #LEFT JOIN ACCO 
    #ON H.HOUSE_ID = ACCO.HOUSE_ID
    LEFT JOIN DDATE
    ON H.ACCOMMODATION_CODE = DDATE.PropertyCode
    LEFT JOIN BG1
    ON (H.HOUSE_ID = BG1.HOUSE_ID) #AND H.ACCOMMODATION_CODE = BG.ACCOMMODATION_CODE)
    LEFT JOIN BG2
    ON (H.HOUSE_ID = BG2.HOUSE_ID)
    LEFT JOIN BV_ACCO
    ON H.ACCOMMODATION_CODE = BV_ACCO.ACCOMMODATION_CODE
    LEFT JOIN DCR 
    ON H.ACCOMMODATION_CODE = DCR.house_id 
    LEFT JOIN AGENT 
    ON (H.HOUSE_ID = AGENT.HOUSE_ID AND H.ACCOMMODATION_CODE = AGENT.ACCOMMODATION_CODE)
    WHERE H.HOUSE_ID not like '%US%'
    #AND DDATE.Status = "D"
    #AND COMPANY = "BELVILLA"
ORDER BY YEARMON, H.HOUSE_ID)
WHERE RANKING = 1),

#FINALHA : FINAL HOMES AND ACCO
FINALHA AS (SELECT H.HOUSE_ID, IF(H.COMPANY = "BELVILLA",A.ACCOMMODATION_CODE, H.HOUSE_ID) AS ACCOMMODATION_CODE, H.COMPANY, H.YEARMON, H.COUNTRY, H.STOCK, H.Status, H.REGION, H.HOME_TYPE, 
H.CONTRACT_TYPE, H.BDM, H.FLOW_L1, H.FLOW_L2, H.FLOW_L3, H.ADDS  FROM HOMESL H
LEFT JOIN ACCO A
ON H.HOUSE_ID = A.HOUSE_ID),

PAX_BV as (
SELECT ACCOMMODATION_CODE as ID, NUMBER_OF_PERSONS AS PAX, BEDROOM_COUNT as BED_COUNT, ACCO_DESCRIPTION AS HOME_TYPE, "BELVILLA" AS COMPANY
FROM `rev-man-leisure.DM.BV_ACCO`
),

PAX_DC as (
select distinct a.house_id as ID, max_persons as PAX, no_bedrooms as BED_COUNT,
case when product_type=1 then 'Pool Home'
when product_type=2 then 'Spa Home'
when product_type=3 then 'Sauna Home'
when product_type=4 then 'Standard Home'
when product_type=5 then 'vacation Park'
when product_type=6 then 'Apartment'
else 'UNKN' end as HOME_TYPE, "DANCENTER" AS COMPANY
from `ovh-dynamic-pricing.LANDING.DANCENTER_INTERNAL_STATIC` a
inner join (select house_id
from `ovh-dynamic-pricing.LANDING.DANCENTER_INTERNAL_STATIC` group by 1) b
on a.house_id=b.house_id 
#WHERE DATE(_PARTITIONTIME) = "2021-01-21"
),

FINALPAX AS (
SELECT * FROM PAX_BV
UNION ALL
SELECT * FROM PAX_DC
),


FINAL AS (SELECT F.HOUSE_ID, F.ACCOMMODATION_CODE,  F.COMPANY, F.YEARMON, F.COUNTRY, F.STOCK, F.Status,  F.REGION,  
MAX(IF(FP.HOME_TYPE ="Apartment","Apartment","Non-Apartment")) as HOME_TYPE, F.CONTRACT_TYPE,
F.ADDS, max(FP.PAX) as PAX , F.FLOW_L1, F.FLOW_L2, F.FLOW_L3, F.BDM, max(FP.BED_COUNT) as BED_COUNT
FROM FINALHA F
LEFT JOIN 
FINALPAX FP
ON F.ACCOMMODATION_CODE = FP.ID
LEFT JOIN DDATE
ON F.ACCOMMODATION_CODE = DDATE.PropertyCode
WHERE F.HOUSE_ID not like '%US%'
AND DDATE.Status = "D"

GROUP BY 1,2,3,4,5,6,7,8,CONTRACT_TYPE,10,11,FLOW_L1,FLOW_L2,FLOW_L3,BDM)
#WHERE HL.ACCOMMODATION_CODE  = "GB-00019-67"

SELECT distinct * FROM FINAL
#WHERE CONTRACT_TYPE IN ("FME","FMNE")
ORDER BY YEARMON, HOUSE_ID
#WHERE COMPANY = "BELVILLA"

#group by COMPANY 
#ORDER BY YEARMON, HOUSE_ID
#WHERE COMPANY = "BELVILLA"
